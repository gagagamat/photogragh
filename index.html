<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ§‹å›³ã‚µãƒãƒ¼ãƒˆã‚¢ãƒ—ãƒªï¼ˆiOSå¯¾å¿œï¼‰</title>

<style>
:root { color-scheme: dark; }
body{
  margin:0; background:#111; color:#fff;
  font-family:system-ui,sans-serif;
  display:flex; flex-direction:column;
  align-items:center; min-height:100vh;
}
h1{ font-size:18px; margin:10px 0; }
canvas{
  border:1px solid #555;
  width:100vw; max-height:70vh;
}
button{
  padding:14px 20px;
  font-size:16px;
  min-height:44px;
  background:#444; color:#fff;
  border:none; border-radius:8px;
}
#controls,#sensitivity{
  margin-top:10px;
  display:flex; gap:10px;
  flex-wrap:wrap; justify-content:center;
}
#sensitivity{
  flex-direction:column;
  width:90%; max-width:320px;
}
label{ display:flex; justify-content:space-between; }
#video{
  position:absolute; width:1px; height:1px; opacity:0;
}
</style>
</head>

<body>
<h1>æ§‹å›³ã‚µãƒãƒ¼ãƒˆã‚¢ãƒ—ãƒªï¼ˆiOSå¯¾å¿œï¼‰</h1>

<button id="startBtn">ğŸ“· ã‚«ãƒ¡ãƒ©é–‹å§‹</button>

<video id="video" playsinline muted></video>
<canvas id="canvas"></canvas>

<div id="controls">
  <button id="switchBtn">ã‚«ãƒ¡ãƒ©åˆ‡æ›¿</button>
  <button id="gridBtn">æ§‹å›³åˆ‡æ›¿</button>
</div>

<div id="sensitivity">
  <label>æ„Ÿåº¦1 <span id="th1val">100</span></label>
  <input type="range" id="th1" min="0" max="500" value="100">
  <label>æ„Ÿåº¦2 <span id="th2val">200</span></label>
  <input type="range" id="th2" min="0" max="500" value="200">
</div>

<div id="score">Score: --</div>

<script async src="https://docs.opencv.org/4.8.0/opencv.js"></script>
<script>
let video = document.getElementById('video');
let canvas = document.getElementById('canvas');
let ctx = canvas.getContext('2d');

let useThree = true;
let useFront = false;
let stream;
let src, gray, edges;
let cvReady = false;

const dpr = window.devicePixelRatio || 1;
const th1 = document.getElementById('th1');
const th2 = document.getElementById('th2');
th1.oninput = ()=> th1val.textContent = th1.value;
th2.oninput = ()=> th2val.textContent = th2.value;

window.Module = {
  onRuntimeInitialized(){ cvReady = true; }
};

document.getElementById('startBtn').onclick = async ()=>{
  await startCamera();
  initCV();
  loop();
};

document.getElementById('switchBtn').onclick = async ()=>{
  useFront = !useFront;
  await startCamera();
};

document.getElementById('gridBtn').onclick = ()=> useThree = !useThree;

function resizeCanvas(){
  const w = innerWidth;
  const h = innerHeight * 0.7;
  canvas.style.width = w + "px";
  canvas.style.height = h + "px";
  canvas.width = w * dpr;
  canvas.height = h * dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
}

async function startCamera(){
  if(stream) stream.getTracks().forEach(t=>t.stop());

  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video:{
        facingMode: useFront ? "user" : { exact:"environment" }
      }
    });
  }catch{
    stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode: useFront ? "user" : "environment" }
    });
  }

  video.srcObject = stream;
  await video.play();
  resizeCanvas();
}

function initCV(){
  src = new cv.Mat(canvas.height/dpr, canvas.width/dpr, cv.CV_8UC4);
  gray = new cv.Mat();
  edges = new cv.Mat();
}

function drawGrid(){
  const w = canvas.width/dpr, h = canvas.height/dpr;
  ctx.strokeStyle="rgba(255,255,255,0.6)";
  if(useThree){
    [w/3,2*w/3].forEach(x=>{ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h);ctx.stroke();});
    [h/3,2*h/3].forEach(y=>{ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(w,y);ctx.stroke();});
  }else{
    ctx.beginPath(); ctx.moveTo(0,h/2); ctx.lineTo(w,h/2); ctx.stroke();
  }
}

function loop(){
  if(!cvReady || video.readyState<2){ requestAnimationFrame(loop); return; }

  ctx.drawImage(video,0,0,canvas.width/dpr,canvas.height/dpr);
  let img = ctx.getImageData(0,0,canvas.width/dpr,canvas.height/dpr);
  src.data.set(img.data);

  cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY);
  cv.Canny(gray,edges,+th1.value,+th2.value);

  drawGrid();
  requestAnimationFrame(loop);
}
</script>
</body>
</html>
